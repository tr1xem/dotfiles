#!/usr/bin/env bash

machine_exists() {
	machinectl list-images | grep subvolume | cut -f 1 -d ' ' | grep -Fxq "${1#*@}"
}

machine_active() {
	machinectl list | grep container | cut -f 1 -d ' ' | grep -Fxq "${1#*@}"
}

list_machines() {
	machinectl list-images | grep subvolume | cut -f 1 -d ' ' | sort
}

have_label() {
	cat /usr/local/etc/nspawn/labels | grep -Fq "${1#*@}"
}

print_label() {
	m="${1#*@}"
	have_label "$1" && ( cat /usr/local/etc/nspawn/labels | grep -F "$m" | cut -f 2 -d ' ' ) || echo "$m"
}

have_terminal() {
	m="${1#*@}"
	( sudo pacman -Qs --sysroot /var/lib/machines/"$m" gaspar-device-gpu >/dev/null && sudo test -f /var/lib/machines/"$m"/usr/bin/alacritty ) || sudo test -f /var/lib/machines/"$m"/usr/bin/uxterm
}

wait_machine() {
	machine="${1#*@}"
	c=0
	while :;
	do
		c=$(( c + 1 ))

		if machine_active "$machine"
		then
			if ! sudo machinectl shell "$machine" /usr/bin/echo 2>&1 >/dev/null
			then
				sleep 1;
				continue
			fi
			return 0
			# break
		elif [[ "$c" -ge 5 ]]
		then
			return 1
			# break
		fi
	done
}

device_mount() {
	m="${1#*@}"
	d="$2"
	o=${@:3}

	if ! machine_active "$m"
	then
		echo "Machine $m isn't active"
		exit -1
	fi

	if [ ! -b "$2" ] && [ ! -c "$2" ]
	then
		echo "No such device $d"
		exit -1
	fi

	machinectl bind --mkdir "$m" "$d" $o
	systemctl set-property --runtime systemd-nspawn@"$m".service DeviceAllow="$d"
}

upgrade() {
	# TODO:
	# collect the package list of the container(s), download to a directory on
	# host with pacman -Sw, then mount it to the containers and then upgrade
	m="${1#*@}"

	active=false
	machine_active "$m" && active=true

	if [ false = "$active" ]
	then
		sudo machinectl start "$m" && echo nspawn "Booting $m"
	fi

	if wait_machine "$m"
	then
		# FIXME: unmount all mounted packages (e.g. fonts)
		# we unmount mirrorlist because pacman-mirrorlist fails to upgrade

		mirrorlist_mounted=false
		sudo machinectl shell "root@$m" /usr/bin/mount | grep -Fq /etc/pacman.d/mirrorlist && mirrorlist_mounted=true

		sudo machinectl shell "root@$m" /usr/bin/pacman -Syyw
		if [ true = "$mirrorlist_mounted" ]
		then
			sudo machinectl shell "root@$m" /usr/bin/umount /etc/pacman.d/mirrorlist
		fi
		sudo machinectl shell "root@$m" /usr/bin/pacman -Suu
		if [ true = "$mirrorlist_mounted" ]
		then
			sudo machinectl bind --mkdir --read-only "$m" /etc/pacman.d/mirrorlist
		fi
		sudo machinectl shell "root@$m" /usr/bin/pacman -Scc

		if [ -d "/usr/local/etc/nspawn/upgrade/$m" ] ; then
			for f in $(find "/usr/local/etc/nspawn/upgrade/$m" -type f -name "*.sh" \
				| sort -n -t / -k 8n)
			do
				fname=$(basename "$f")
				if echo "$fname" | grep -Fq @
				then
					uname=${fname#*@}
					uname=${uname%%.*}
					host="$uname@$m"
				else
					uname=''
					host="$m"
				fi

				sudo machinectl shell "$host" "/tmp/upgrade/$fname"
			done
		fi
	else
		notify "Failed to upgrade the machine $m"
	fi

	if [ false = "$active" ]
	then
		sudo machinectl poweroff "$m" &&  notify "Powereing off $m"
	fi
}

list_terminals() {
	terminals=""
	while read s
	do
		have_terminal "$s" && terminals="$terminals$s\n"
	done < <(cat /usr/local/etc/nspawn/terminals | sort -t @ -k 2n)
	echo -en "$terminals"
}

CALLER_USER="${SUDO_USER:-$USER}"

if [[ $EUID -ne 0 ]]
then
	if ! systemd-detect-virt --container >/dev/null 2>&1
	then
		exec sudo -- "$0" "$@"
	fi
fi

notify() {
	local uid=$(id -u "$CALLER_USER")
	local msg="$@"
	sudo -u "$CALLER_USER" DISPLAY=:0 DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$uid/bus" \
	dunstify "ï’·  nspawn" "$msg"
}

upgrade2() {
	DB_DIR=/var/cache/nspawn/pacman/db
	mkdir -p "$DB_DIR"
	pacman -Sy --dbpath "$DB_DIR"
	pkgs=""
	for m in $(list_machines); do
		MACHINE_DIR=/var/lib/machines/"$m"
		mount --mkdir --bind "$DB_DIR" "$MACHINE_DIR$DB_DIR"
		mount | rg pacman
		pacman -Qu --sysroot "$MACHINE_DIR" --dbpath "$DB_DIR"
		pkgs=$pkgs$(pacman -Qu --sysroot "$MACHINE_DIR" --dbpath "$DB_DIR")
		echo "$MACHINE_DIR$DB_DIR"
		ls "$MACHINE_DIR$DB_DIR/sync"
		umount "$MACHINE_DIR$DB_DIR"
		figlet "upgrading $m"
		break
	done
	echo XX
	echo "$pkgs"
}

upgrade_all() {
	for m in $(list_machines); do
		figlet "upgrading $m"
		upgrade "$m"
	done
}

if [[ "$1" == menu ]]
then
	picks="terminal\ntoggle\nshell"
	pick=$(echo -e "$picks" | dmenu -l 20 -p nspawn:)
	[ -z "$pick" ] && exit
	echo -e "$picks" | grep -Fxq "$pick" || exit
	$0 "$pick"
elif [[ "$1" == toggle ]]
then
	list=""

	while read m
	do
		s=''
		machine_active "$m" && s="currently on" || s="currently off"
		l=$(print_label "$m")
		list="$list$l+$m+($s)\n"
	done < <(list_machines)

	list=$(echo -en "$list" | column -t -s +)
	m=$(echo -en "$list" | dmenu -p toggle: -l 20 | sed 's/\s\+/+/g')

	pick=$(echo "$m" | cut -f 2 -d +)
	machine_exists "$pick" || exit

	if machine_active "$pick"
	then
		sudo machinectl poweroff "$pick" &&  notify "Powereing off $pick"
	else
		sudo machinectl start "$pick" && notify "Booting $pick"
	fi
elif [[ "$1" == shell ]]
then
	[ ! -f /usr/local/etc/nspawn/terminals ] && exit

	terminals=$(cat /usr/local/etc/nspawn/terminals | sort -t @ -k 2n)

	if [ ! -z "$terminals" ]
	then
		pick=$(echo "$terminals" | dmenu -l 20 -p "shell:")

		if [ ! -z "$pick" ]
		then
			machine=${pick#*@}

			was_active=0

			machine_exists "$machine" || exit
			machine_active "$machine" || ( sudo machinectl start "$machine" && notify "Booting $machine" )

			if wait_machine "$machine"
			then
				sudo -u "$CALLER_USER" alacritty -e sh -c "sudo machinectl shell $pick; read"
			else
				notify "Failed to run shell inside $machine"
			fi
		fi
	fi
elif [[ "$1" == terminal ]]
then
	[ ! -f /usr/local/etc/nspawn/terminals ] && exit

	terminals=$(list_terminals)

	if [ ! -z "$terminals" ]
	then
		pick=$(echo "$terminals" | dmenu -l 20 -p "terminal:")

		if [ ! -z "$pick" ]
		then
			machine=${pick#*@}

			was_active=0

			machine_exists "$machine" || exit
			machine_active "$machine" || ( sudo machinectl start "$machine" && notify "Booting $machine" )

			if wait_machine "$machine"
			then
				sudo machinectl shell "$pick" $0 2>/dev/null
			else
				notify "Failed to run terminal on $machine"
			fi
		fi
	fi
elif [[ "$1" == '' ]]
then
	export DISPLAY=:0
	export XAUTHORITY=/tmp/nspawn/xauth

	pacman -Qs gaspar-device-gpu >/dev/null && test -f /usr/bin/alacritty && alacritty || uxterm
else
	$1 ${@:2}
fi
