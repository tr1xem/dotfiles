#!/bin/sh
# Screenshot helper for hyprland.
# Copyright 2023, Adrian Lopez.

ezauth="key:$EZAUTH"
ezuploadurl="https://api.e-z.host/files"
monarchauth="secret=$MONARCHKEY"
monarchuploadurl="https://api.monarchupload.cc/v3/upload"


# CHECK WAYLAND SESSION
# ======================================
if [ -z "$WAYLAND_DISPLAY" ]; then
  (>&2 echo Wayland is not running)
  exit 1
fi
random_string=$(LC_ALL=C tr -dc 'a-zA-Z0-9' </dev/urandom | head -c 7)
focused_window=$(hyprctl activewindow)
app_name=$(echo "$focused_window" | grep "class:" | awk '{print $2}')
time=$(date "+%d-%b_%H-%M-%S")

if [[ -z "$app_name" ]]; then
    file="${random_string}.png"
else
    file="${random_string}-${app_name}.png"
fi
## If exists ~/.config/hyprshotgun/hyprshotgun.conf,
## source the file and use the variables defined there,
## else, set default values:
if [ -f ~/.config/hyprshotgun/hyprshotgun.conf ]; then
  . ~/.config/hyprshotgun/hyprshotgun.conf
else
  if [ -z "$HYPRSHOTGUN_SCREENSHOTS" ]; then
    HYPRSHOTGUN_SCREENSHOTS=$(xdg-user-dir PICTURES)/Screenshots
  fi
  SCREENSHOT_TIMESTAMP=$(date "+${HYPRSHOTGUN_DATEFMT:-%F_%H-%M-%S_%N}")
  #file name formatting
  SCREENSHOT_FULLNAME="$HYPRSHOTGUN_SCREENSHOTS"/"$file"
fi


# HELPER FUNCTIONS
# ======================================
display_help(){
  GREEN='\033[32m'
  YELLOW='\033[33m'
  RED='\033[31m'
  CYAN='\033[36m'
  RESET='\033[0m'

  echo -e "$GREEN# HOW TO USE$RESET"
  echo -e ""$YELLOW"===================$RESET"
  echo -e "$RED*$RESET Local screenshot:"
  echo -e "hyprshotgun $CYAN[display|window|region|alldisplays]$RESET"
  echo ""
  echo -e "$RED*$RESET Online screenshot:"
  echo -e "hyprshotgun $CYAN[display|window|region|alldisplays]$RESET upload"
  echo ""
  echo ""
  echo -e "$GREEN# ADVANCED SETTINGS$RESET"
  echo -e "$YELLOW===================$RESET"
  echo -e "$RED*$RESET Change the screenshot directory (optional):"
  echo 'By default, the screenshots are saved in $XDG_PICTURES_DIR. You can choose a different directory by setting the env var $HYPRSHOTGUN_SCREENSHOTS="/my/screenshot/directory/". Alternatively, you can export that same env var inside the config file ".config/hyprshotgun/hyprshotgun.conf".'
  echo
}

take_screenshot() {
  case "$1" in
    -h|--help)
      display_help
      return 0
      ;;
    display)
      grimblast --freeze save output "$2"
      ;;
    region)
      grimblast --freeze save area "$2"
      ;;
    window)
      grimblast --freeze save active "$2"
      ;;
    alldisplays)
      grimblast --freeze save screen "$2"
      ;;
    *)
      echo "Invalid argument:"
      echo ""
      display_help
      return 0
      ;;
  esac
}

upload_screenshot(){
  # If there is not screenshot file, then there is nothing to upload
  if [ ! -f "$SCREENSHOT_FULLNAME" ]; then exit; fi

  # Upload
  case "$1" in
    upload)
      # If curl exist, use it to upload the image to 0x0
      if type curl >/dev/null  2>&1; then

        SCREENSHOT_LOCATOR=$( curl -X POST -F "file=@/$SCREENSHOT_FULLNAME" -H $ezauth  -v $ezuploadurl 2>/dev/null)
        echo $SCREENSHOT_LOCATOR
      fi
      ;;
  esac
}

# We support wl-copy, xsel, and xclip.
# The first one found by order of priority will be used.
copy_to_clipboard() {
  if type jq >/dev/null 2>&1 && type wl-copy >/dev/null 2>&1; then
    # Assuming $1 is the full JSON response
    url=$(echo "$1" | jq -r '.imageUrl')

    if [ -n "$url" ]; then
      printf "%s" "$url" | wl-copy
    else
      echo "URL not found in response"
    fi
  elif type xsel >/dev/null 2>&1; then
    url=$(echo "$1" | jq -r '.imageUrl')
    if [ -n "$url" ]; then
      printf "%s" "$url" | xsel --clipboard
    else
      echo "URL not found in response"
    fi
    unset HYPRSHOTGUN_WL_COPY_FILE
  elif type xclip &>/dev/null; then
    url=$(echo "$1" | jq -r '.data.url')
    if [ -n "$url" ]; then
      printf "%s" "$url" | xclip -selection clipboard
    else
      echo "URL not found in response"
    fi
    unset HYPRSHOTGUN_WL_COPY_FILE
  else
    echo "$1"
  fi
}


send_notification() {
  if type notify-send >/dev/null 2>&1; then
    # Assuming $1 contains the JSON response with the URL
    url=$(echo "$1" | jq -r '.imageUrl')

    if [ -n "$url" ]; then
      # Send the notification with the URL
      # notify-send -h string:x-canonical-private-synchronous:shot-notify -u normal -i "dialog-information" "$3" "$url"
      notify-send -e "Image URL copied to clipboard: "$url -a "Hyprshotgun" -i $SCREENSHOT_FULLNAME

    else
      echo "URL not found in response"
    fi
  fi
}

# The actual notification we show
show_notification(){
  case "$1" in
    upload)
      if [ -z $SCREENSHOT_LOCATOR ]; then
        copy_to_clipboard "$SCREENSHOT_FULLNAME"
        send_notification "$SCREENSHOT_FULLNAME" document-save "ðŸ“‹ Online screenshots are not available at the moment. Image path copied:"
      else
        copy_to_clipboard "$SCREENSHOT_LOCATOR"
        send_notification "$SCREENSHOT_LOCATOR" document-send "ðŸ“‹ Image URL copied:"
      fi
      ;;
    *)
      copy_to_clipboard "$SCREENSHOT_FULLNAME"
      send_notification "$SCREENSHOT_FULLNAME" document-save "ðŸ“‹ Image path copied:"
  esac
}


# ENTRY POINT OF THE PROGRAM
# ======================================
take_screenshot "$1" "$SCREENSHOT_FULLNAME"
upload_screenshot "$2"
show_notification "$2"
