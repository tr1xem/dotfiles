#!/bin/bash

# Check if running as root
if [ "$(id -u)" -ne 0 ]; then
    echo "This script must be run as root."
    exec sudo "$0" "$@"
    exit 1
fi

# Function to run dbus-send and handle errors
run_dbus_get() {
    local property=$1
    local output
    output=$(dbus-send --system --print-reply --dest=org.scx.Loader /org/scx/Loader \
             org.freedesktop.DBus.Properties.Get string:org.scx.Loader string:"$property" 2>&1)
    if echo "$output" | grep -q "Error"; then
        echo "[tr1x_em] :Error fetching $property: $output" | tee /dev/kmsg
        exit 1
    fi
    echo "$output"
}

# Function to extract value from dbus-send output
extract_dbus_value() {
    local output=$1
    # Extract the value after 'variant' (e.g., string "scx_lavd" or uint32 2)
    echo "$output" | grep -oP 'variant\s+\w+\s+"?\K[^"]+' | tail -1
}

# Get current scheduler and mode
scheduler_output=$(run_dbus_get CurrentScheduler)
mode_output=$(run_dbus_get SchedulerMode)

# Extract values
current_scheduler=$(extract_dbus_value "$scheduler_output")
current_mode=$(extract_dbus_value "$mode_output")

# Log for debugging
echo "[tr1x_em] :Current scheduler: $current_scheduler, mode: $current_mode" | tee /dev/kmsg

# Check if scheduler is scx_lavd
if [ "$current_scheduler" = "scx_lavd" ]; then
    if [ "$current_mode" = "2" ]; then
        echo "[tr1x_em] :scx already set to powersaving"
    else
        echo "[tr1x_em] :Switching scx to powersaving mode" | tee /dev/kmsg
        dbus-send --system --print-reply --dest=org.scx.Loader /org/scx/Loader \
                  org.scx.Loader.SwitchScheduler string:scx_lavd uint32:2 >/dev/null 2>&1 | tee /dev/kmsg
        if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "[tr1x_em] :Error switching to powersaving mode" | tee /dev/kmsg
            exit 1
        fi
    fi
else
    echo "[tr1x_em] :Switching to scx_lavd and powersaving mode" | tee /dev/kmsg
    dbus-send --system --print-reply --dest=org.scx.Loader /org/scx/Loader \
              org.scx.Loader.SwitchScheduler string:scx_lavd uint32:2 >/dev/null 2>&1 | tee /dev/kmsg
    if [ ${PIPESTATUS[0]} -ne 0 ]; then
        echo "[tr1x_em] :Error switching to scx_lavd powersaving mode" | tee /dev/kmsg
        exit 1
    fi
fi
pl1=45000000
pl2=45000000
currentpl=$(cat /sys/devices/virtual/powercap/intel-rapl-mmio/intel-rapl-mmio:0/constraint_0_power_limit_uw)
if [ "$currentpl" != "$pl1" ]; then
    echo "Setting PL1 to 45W"
    echo $pl1 | sudo tee /sys/devices/virtual/powercap/intel-rapl-mmio/intel-rapl-mmio:0/constraint_0_power_limit_uw
    echo $pl2 | sudo tee /sys/devices/virtual/powercap/intel-rapl-mmio/intel-rapl-mmio:0/constraint_1_power_limit_uw
    # sudo auto-cpufreq --force='powersave'
    echo "[tr1x_em] :powerlimits set for powersaving " | tee /dev/kmsg
else
    echo "[tr1x_em] :powerlimits already set for powersaving "
fi
#
#






# tlp bat
# cpupower -c all set --perf-bias 15
# cpupower -c 0-11 frequency-set -d 0.8GHz -u 1.2GHz
# cpupower -c 12-19 frequency-set -d 0.8GHz -u 1GHz
# cpupower -c all frequency-set -g powersave
# current_scheduler=$(grep "^SCX_SCHEDULER=" "/etc/default/scx" | cut -d'=' -f2)
# current_flags=$(grep "^SCX_FLAGS=" "/etc/default/scx" | cut -d'=' -f2 | xargs)
# new_scheduler="scx_lavd"
# new_flags="--powersave "
# if [ "$new_flags" != "$current_flags" ]; then
#     echo "lavd :powersave "
#     sed -i -e "s/^SCX_SCHEDULER=.*/SCX_SCHEDULER=$new_scheduler/" \
#         -e "s/^SCX_FLAGS=.*/SCX_FLAGS=\"$new_flags\"/" "/etc/default/scx"
#     systemctl restart scx
# else
#     echo "lavd powersave already set ! "
# fi
# /usr/bin/python /home/saumya/.config/hypr/g15-fan-cli.py p
#made for the systemd service
# echo 55000000 | sudo tee /sys/devices/virtual/powercap/intel-rapl-mmio/intel-rapl-mmio:0/constraint_0_power_limit_uw

# sudo nvidia-smi -lgc 210,2580
# sudo nvidia-smi --reset-gpu-clocks

